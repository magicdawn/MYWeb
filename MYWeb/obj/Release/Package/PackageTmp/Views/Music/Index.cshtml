@{
    ViewBag.Title = "音乐管理";
}

<div class="container">
    <div style="margin:50px;"></div>
    <form action="@Url.Action("Upload")" method="post" enctype="multipart/form-data">
        <h1>上传mp3文件</h1>
        <input type="file" name="mp3" title="上传" accept="*mp3" width="500px" id="mp3" />
        <input type="submit" value="上传" id="btnUpload" class="btn" />

        <script src="~/Content/AjaxUpload/ajaxfileupload.js"></script>
        <script>
            $(function () {
                var $loading = $("#loading");

                $("#btnUpload").click(function (e) {
                    //不调到action
                    e.preventDefault();

                    //验证文件
                    if ($("#mp3").val() == "")
                    {
                        alert("还没有选取文件呢~");
                        return;
                    }
                    var path = $("#mp3").val();
                    var ext = path.substring(path.lastIndexOf("."));
                    if (!(ext == ".mp3" || ext == ".MP3" || ext == ".wma" || ext == ".WMA"))
                    {
                        alert("只支持MP3 和 WMA 格式");
                        return;
                    }

                    //loading动画,上传按钮
                    $loading.show();
                    this.disabled = true;

                    $.ajaxFileUpload({
                        url: $("form").prop("action"),
                        secureuri: false,
                        fileElementId: 'mp3',
                        dataType: 'json',
                        success: function (res) {
                            //隐藏动画,恢复按钮
                            $loading.hide();
                            $("#btnUpload").prop("disabled",false);

                            if (res.UploadSuccess)
                            {
                                //上传成功
                                $("#message").html(
                                    "<h4 class='text-success'>" + res.Message + "</h4>" +
                                    "<br />" +
                                    //复制按钮
                                    "<button class='btn btn-info' id='copyPath'>复制路径</button>" +

                                    "<p class='text-info' id='div-path'>" + res.Path + "</p>"
                                );
                            }
                            else
                            {
                                //上传失败
                                $("#message").html(
                                    "<p class='text-error'>" + res.Message + "</p>"
                                );
                            }
                            alert(res.Message);
                        }
                    })
                    //$.post(url, { "file": file }, function (res) {
                    //    if (res.UploadSuccess)
                    //    {
                    //        //上传成功
                    //        $("#message").text(res.Message + "<br />" + res.Path);
                    //    }
                    //    else
                    //    {
                    //        $("#message").text(res.Message);
                    //    }
                    //    alert(res.Message);
                    //}, 'json');
                });

                $("#copyPath").live("click", function () {
                    if (typeof (clipBoardData) != "undefined")
                    {
                        clipboardData.setData("text", $("#div-path").text());
                        alert("已成功复制到剪贴板");
                    }
                    else
                    {
                        alert("复制功能不支持你的浏览器,请手动复制");
                    }
                });
            });
        </script>
    </form>
    <div id="message">
        <div id="loading" style="display:none">
            <h2 class="text-warning">正在缓慢上传,请骚后...</h2>
            <img src="~/Image/Music/loading-step.gif" />
        </div>
    </div>
    <table class="table table-bordered"></table>
</div>